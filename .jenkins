pipeline {

  agent any

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }
    stage('Tools') {
      steps {
        sh 'helm version --client'
      }
    }
    stage('Lint') {
      steps {
        sh 'helm lint */'
      }
    }
    stage('Publish') {
      when {
        branch 'master'
      }
      environment {
        GOOGLE_APPLICATION_CREDENTIALS = credentials('vio-build-gcp-serviceaccount')
      }
      steps {
        // Create our staging repos
        sh 'mkdir -p .chart-repo .chart-staging'
        // Mount .chart-repo to Google Cloud Storage
        sh 'gcsfuse charts.vapor.io .chart-repo'
        // Build packages in .chart-staging, move new ones to .chart-repo (gcs), create new index
        sh 'helm package --dependency-update --destination .chart-staging */'
        sh 'cp -vn .chart-staging/*.tgz .chart-repo/'
        sh 'helm repo index --url https://charts.vapor.io .chart-repo'
        sh 'gsutil setmeta -h "Cache-Control:no-cache,max-age=0"  -h "Content-Type:text/yaml" -h "Content-Encoding:UTF-8" gs://charts.vapor.io/*.yaml'
      }
      post {
        always {
          sh 'fusermount -u .chart-repo && rm -rf .chart-staging .chart-repo'
        }
      }
    }
  }
}
